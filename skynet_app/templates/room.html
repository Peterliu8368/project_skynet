
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skynet</title>
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}" />
    <script src="https://kit.fontawesome.com/c939d0e917.js"></script>
</head>
<body>
    <div class="header">
        <div class="logo">
            <h3>Welcome to Skynet</h3>
        </div>
    </div>  
    <div class="main">  
        <div class="main__left">
            <div class="videos__group">
                <div id="video-grid">

                </div>
            </div>
            <div class="options">
                <div class="options__left">
                    <div id="stopVideo" class="options__button">
                        <i class="fa fa-video-camera"></i>
                    </div>
                    <div id="muteButton" class="options__button">
                        <i class="fa fa-microphone"></i>
                    </div>
                </div>
                <div class="options__right">
                    <div id="inviteButton" class="options__button">
                        <i class="fas fa-user-plus"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="main__right">
            <div class="main__chat_window">
                <div class="messages"></div>
            </div>
            <div class="main__message_container">
                    <input id="chat_message" type="text" autocomplete="off" placeholder="Type message here...">
                <div id="send" class="options__button">
                    <i class="fa fa-plus" aria-hidden="true"></i>
                </div>
            </div>
        </div>
    </div>
</body>
    <script src="{{ url_for('static', filename = 'script.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        const ROOM_ID = "{{roomId}}";
        const socket = io();
        const videoGrid = document.getElementById("video-grid");
        const myVideo = document.createElement("video");
        myVideo.muted = true;
        var peer = new Peer();

        //adding video
        function addVideoStream(video, stream) {
            video.srcObject = stream
            video.addEventListener('loadedmetadata', () => {
                video.play();
                videoGrid.append(video)

            })
        }

        let myVideoStream;
        navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true,
        })
        .then((stream) => {
            myVideoStream = stream;
            addVideoStream(myVideo, stream);

            peer.on('call', mediaConnection => {
                mediaConnection.answer(stream);
                const video = document.createElement("video")
                mediaConnection.on('stream', userStream => {
                    addVideoStream(video, userStream);
                })
            })
            
            socket.on('user-connected', userId => {
                const call = peer.call(userId, stream)
                const video = document.createElement("video")
                call.on('stream', userStream => {
                    addVideoStream(video, userStream);
                })
            })
            
        });
        
        //when a user is connected to the peer server
        peer.on('open', id => { 
            socket.emit('join-room', ROOM_ID, id)
        })



    </script>
</html>